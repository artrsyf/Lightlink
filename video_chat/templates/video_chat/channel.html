{% extends 'video_chat/home_base.html' %}
{% load static %}
{% block main_panel %}
<style>
    html, body, ul{
        margin: 0px;
        padding: 0px;
    }
    .non_ref{
        text-decoration: none;
        color: #666;
    }
    li{
        list-style-type: none;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    body{
      min-height: 100vh;
      min-width: 100vw;
    }
    .content{
        height:100%;
        width:100%;
        
    }
    .global_wrapper{
        height:100%;
        width:100%;
        display: flex;
        flex-direction: row;
    }
    .main_panel{
        height: 100%;
        flex-grow: 1;
        background-color: lightcoral;
    }
    .side_panel{
        height: 100%;
        width: 272px;
        background-color: lightblue;
        display: flex;
        flex-direction: column;
    }
    .profile_panel{
        background-color: aqua;
        display:flex;
        flex-direction: column;
    }
    .profile_part{
        display: flex;
        flex-direction: row;
        align-items: center;
    }
    .profile_info{
        display: flex;
        flex-direction: row;
    }
    .profile_img_wrapper{
        padding: 5px;
    }
    .profile_img{
        height: 50px;
        width: 50px;
        border-radius: 50%;
    }
    .profile_options{

    }
    .profile_nicknames{
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: start;
        justify-content: center;
    }
    .profile_nickname{
        font-size: 1rem;
        font-weight: 500;
        color: white;
    }
    .user_nickname{
        font-size: 0.8rem;
        color: #666;
    }
    .profile_options{
        display:flex;
        flex-direction: row;
        flex-grow: 1;
        justify-content: space-evenly;
    }
    .interactive_panel{
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .deal_switching{
        display: flex;
        flex-direction: row;
        justify-content: space-evenly;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .non-shift{
        line-height:normal;
    }
    .search_panel{
        padding: 7px 5px 5px 5px;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
    }
    .call_manage_buttons{
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        padding: 5px;
        justify-content: space-around;
    }
    .side_panel_button{
        width: calc((100% - 10px) / 2);
    }
    .personal_messages{
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .messages_label{
        padding: 7px 5px 5px 10px;
    }
    .messages_wrapper{
        flex-grow: 1;
        margin-top: 5px;
        overflow-y: auto;
        overflow-x: hidden;
        max-height: 75vh;
    }
    .message_item{
        display: flex;
        flex-direction: row;
        padding: 5px 5px 5px 10px;
    }
    .messages_users_avatar{
        height:40px;
        width: 40px;
        border-radius: 50%;
    }
    .message_info{
        display: flex;
        flex-direction: column;
        align-items: start;
        flex-grow: 1;
        padding-left: 7px;
    }
    .conv_user_nickname{
        font-size: 1rem;
    }
    .conversation_status{
        font-size: 0.85rem;
        width: 100%;
    }
    .message_data{
        font-size: 0.7rem;
        align-self: flex-end;
    }
    .nickname_data{
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }
    .big_profile_img{
        height: 100px;
        width: 100px;
        border-radius: 50%;
    }
    .welcome_message{
        font-weight: 360;
        font-size: 2rem;
    }
    .pure_page_user_nickname{
        font-weight: 600;
        font-size: 2rem;
    }
    .big_profile_info{
        height: 20%;
        width: 100%;
        justify-content: center;
    }
    .pure_profile_img_wrapper{
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-right: 3%;
    }
    .main_panel{
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .videochat_wrapper{
        width: 100%;
        height: 50%;
        background-color: burlywood;
    }
    .textchat_wrapper{
        width: 100%;
        height: 50%;
    }
    .videochat_content{
        width: 100%;
        height: 100%;
        padding: 10px 10px 10px 10px;
        display: flex;
        flex-direction: column;
    }
    .videochat_info{
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }
    .videocall_status{
        display: flex;
        flex-direction: row;
        width: 13%;
        align-items: center;
        justify-content: space-between;
    }
    .videocall_toolbar{
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        width: 26%;
    }
    .videostreams_wrapper{
        flex-grow: 1;
        padding-top: 30px;
        display: flex;
        flex-direction: row;
        justify-content: center;
        position: relative;
    }
    .videostreams{
        width: fit-content;
        height: 100%;
        display: grid;
        gap: 10px;
    }
    .videostream{
        background-color: #ddd;
    }
    .control_panel_wrapper{
        display: flex;
        flex-direction: row;
        justify-content: center;
        position: absolute;
        bottom: 0;
        width: 100%;
    }
    .control_panel{
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: centers;
    }
</style>

<script type="text/javascript" src="{% static 'js/AgoraRTC_N-4.18.2.js' %}"></script>

<div class="main_panel">
    <div class="videochat_wrapper">
       <div class="videochat_content">
           <div class="videochat_info">
               <div class="videocall_status">
                   <div class="info_button">
                       <i class="fa-solid fa-circle-info"></i>
                   </div>
                   <div class="room_name">
                       CompanionName 
                   </div>
                   <div class="companion_status"> <!-- If room is not channel -->
                       <i class="fa-solid fa-circle"></i>
                   </div>
               </div>
               <div class="videocall_toolbar">
                   <div class="notifications">
                       <i class="fa-solid fa-bell non-shift"></i>
                   </div>
                   <div class="pinned_messages">
                       <i class="fa-solid fa-thumbtack"></i>
                   </div>
                   <div class="chat_members">
                       <i class="fa-solid fa-user-group"></i>
                   </div>
                   <div class="smart_search">
                       <input type="search" name="" id="">
                   </div>
               </div>
           </div>
           <div class="videostreams_wrapper" id="streams_wrapper">
               <div class="videostreams" id="streams_store">
                   <!-- <div class="videostream">

                   </div>
                   <div class="videostream">
                       
                   </div>
                   <div class="videostream">
                       
                   </div>
                   <div class="videostream">
                       
                   </div>
                   <div class="videostream">
                       
                   </div> -->
               </div>
               <div class="control_panel_wrapper">
                   <div class="control_panel">
                       <div class="share_stream_btn" id="share-btn">
                           <button type="submit">
                               <i class="fa-solid fa-desktop"></i>
                           </button>
                       </div>
                       <div class="mute_video_btn" id="video-btn">
                           <button type="submit">
                               <i class="fa-solid fa-video"></i>
                           </button>
                       </div>
                       <div class="mute_mic_btn" id="mic-btn">
                           <button type="submit">
                               <i class="fa-solid fa-microphone-lines"></i>
                           </button>
                       </div>
                       <div class="leave_room_btn" id="leave-btn">
                           <button type="submit">
                               <i class="fa-solid fa-phone-slash fa-flip-horizontal"></i>
                           </button>
                       </div>
                   </div>
               </div>
           </div>
       </div>
    </div>
    <div class="textchat_wrapper">
       <div class="textchat_content">
           <div class="messages_area_wrapper">
               <!-- <div class="message">

               </div>
               <div class="message">
                   
               </div> -->
           </div>
           <div class="message_input_wrapper">
                <input type="text" id="textchat_input_message" placeholder="Write">
           </div>
       </div>
    </div>
</div>
<div id="channel-meta" data-csrf-token="{{ csrf_token }}" channel-id="{{ channel_id }}"></div>
<script type="text/javascript" src="{% static 'js/streams.js' %}"></script>
<script>
    const CSRF_TOKEN = '{{ csrf_token }}'
    const CHANNEL_ID = {{ channel_id }}

    const channelSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + CHANNEL_ID
        + '/'
    )

    channelSocket.onmessage = function(e){
        const data = JSON.parse(e.data)
        const messages_area = document.querySelector('.messages_area_wrapper')
        const message = `<div class="message">${data.message}</div>`
        messages_area.innerHTML += message
    }

    channelSocket.onclose = function(e){
        console.error('Chat socket closed unexpectedly');
    }

    document.querySelector('#textchat_input_message').onkeyup = function(e) {
        if (e.key === 'Enter'){
            message_input_field = document.querySelector('#textchat_input_message')
            const message = message_input_field.value
            channelSocket.send(JSON.stringify({
                'message': message
            }))
            message_input_field.value = ''
        }
    };

    const videostreams = document.getElementById('streams_store')
    var defaultStreamWidth = 0
    const observerOptions = {
        childList: true,
        subtree: false,
        attributes: false
    };
    

    findOptimalDimension = (usersCount) => {
        return Math.ceil(Math.sqrt(usersCount))
    }

    optimizeVideostreamsWrapper = () => {
        let streamsContainer = document.getElementsByClassName('videostream')
        let usersCount = streamsContainer.length
        if (usersCount > 1){
            streamsContainer[0].style.width = 'auto'
            let optimalDimension = findOptimalDimension(usersCount)
            videostreams.style.gridTemplateColumns = `repeat(${optimalDimension}, 1fr)`;
            videostreams.style.justifyItems = ''
            // Идеальная высота - высота грида
            // Идеальная ширина - 48% грида
            let maxStreamHeight = videostreams.clientHeight
            let currentStreamHeight = streamsContainer[0].clientHeight
            let currentStreamWidth = streamsContainer[0].clientWidth
            
            for (let i = 0; i < usersCount; i++){
                //streamsContainer[i].style.width = `${48 / maxStreamHeight * currentStreamHeight}%`
                streamsContainer[i].style.width  = `${defaultStreamWidth / Math.ceil(usersCount / optimalDimension)}`
            }
        }
        else{
            videostreams.style.gridTemplateColumns = ''
            videostreams.style.justifyItems = 'center'
            streamsContainer[0].style.width = `${streams_wrapper.clientWidth * 0.48}px`
            if (defaultStreamWidth == 0) defaultStreamWidth = streamsContainer[0].clientWidth
        }
    }

    function handleChanges(mutationsList, observer) {
        for (const mutation of mutationsList) {
            if (mutation.type === 'childList') {
                optimizeVideostreamsWrapper()
            }
        }
    }
    const observer = new MutationObserver(handleChanges);
    observer.observe(videostreams, observerOptions);
    checker = () => {
        videostreams.innerHTML += "<div class='videostream'></div>"
    }

    optimizeVideostreamsWrapper()
</script>
{% endblock main_panel %}